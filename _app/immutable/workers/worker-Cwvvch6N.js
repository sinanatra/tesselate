(function(){"use strict";function p(s){for(let t=0;t<s.length;t++)s[t]=255-s[t];return s}function v(s,t,l){const e=new Float32Array(s.length);for(let f=0;f<l;f++){const o=f%2===0?1:-1,r=o===1?0:t-1,m=o===1?t:-1;for(let n=r;n!==m;n+=o){const a=f*t+n,c=Math.min(255,Math.max(0,s[a]+e[a])),u=c<128?0:255,i=c-u;s[a]=u;const M=n+o;if(M>=0&&M<t&&(e[a+o]+=i*7/16),f+1<l){M>=0&&M<t&&(e[a+t+o]+=i*1/16),e[a+t]+=i*5/16;const x=n-o;x>=0&&x<t&&(e[a+t-o]+=i*3/16)}}}return s}function A(s,t,l,e=8){const f=new Uint8ClampedArray(s.length);f.fill(255);for(let o=0;o<l;o+=e)for(let r=0;r<t;r+=e){const m=Math.min(r+e,t),n=Math.min(o+e,l);let a=0,c=0;for(let h=o;h<n;h++)for(let d=r;d<m;d++)a+=s[h*t+d],c++;const u=a/c,i=Math.max(0,Math.min(e/2,(1-u/255)*(e/2))),M=r+Math.floor((m-r)/2),x=o+Math.floor((n-o)/2),b=i*i;for(let h=-Math.floor(i);h<=Math.floor(i);h++)for(let d=-Math.floor(i);d<=Math.floor(i);d++)if(d*d+h*h<=b){const g=M+d,y=x+h;g>=0&&g<t&&y>=0&&y<l&&(f[y*t+g]=0)}}return f}self.onmessage=s=>{try{const{imageData:t,settings:l}=s.data,{width:e,height:f}=t;let o=new Uint8ClampedArray(t.data.length/4);for(let n=0,a=0;n<t.data.length;n+=4,a++){const c=t.data[n],u=t.data[n+1],i=t.data[n+2];o[a]=Math.round(.2126*c+.7152*u+.0722*i)}l.invert&&(o=p(o)),l.dither==="floyd"?o=v(o,e,f):l.dither==="halftone"&&(o=A(o,e,f,l.halftone_cell));const r=new Uint8ClampedArray(e*f*4);for(let n=0,a=0;n<r.length;n+=4,a++){const c=o[a]<128?0:255;r[n]=r[n+1]=r[n+2]=c,r[n+3]=255}const m=new ImageData(r,e,f);postMessage({ok:!0,imageData:m},[m.data.buffer])}catch(t){postMessage({ok:!1,error:t&&(t.stack||t.message)||String(t)})}}})();
